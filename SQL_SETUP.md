-- ============================================================
-- DATABASE SETUP SCRIPT
-- INSTRUCTIONS: Copy ALL text in this file, paste into Supabase SQL Editor, and click RUN.
-- ============================================================

-- 1. Profiles Table Updates
-- Adds columns to store calculated calorie targets
ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS daily_calories INTEGER;

ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS weekly_calories INTEGER;

-- 2. Daily Meal Plans Table
-- Stores the specific meals generated by AI for specific dates
CREATE TABLE IF NOT EXISTS daily_meal_plans (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  meals JSONB NOT NULL DEFAULT '[]',
  macros JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, date)
);

-- Enable Security for Meal Plans
ALTER TABLE daily_meal_plans ENABLE ROW LEVEL SECURITY;

-- Allow users to manage only their own plans
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'daily_meal_plans' AND policyname = 'Users can insert their own plans') THEN
        CREATE POLICY "Users can insert their own plans" ON daily_meal_plans FOR INSERT WITH CHECK (auth.uid() = user_id);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'daily_meal_plans' AND policyname = 'Users can select their own plans') THEN
        CREATE POLICY "Users can select their own plans" ON daily_meal_plans FOR SELECT USING (auth.uid() = user_id);
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'daily_meal_plans' AND policyname = 'Users can update their own plans') THEN
        CREATE POLICY "Users can update their own plans" ON daily_meal_plans FOR UPDATE USING (auth.uid() = user_id);
    END IF;
END $$;

-- 3. Progress Logs Table
-- Stores weight, body fat, and photos
CREATE TABLE IF NOT EXISTS progress_logs (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  weight NUMERIC,
  body_fat NUMERIC,
  photo_url TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable Security for Logs
ALTER TABLE progress_logs ENABLE ROW LEVEL SECURITY;

DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'progress_logs' AND policyname = 'Users can manage their own logs') THEN
        CREATE POLICY "Users can manage their own logs" ON progress_logs FOR ALL USING (auth.uid() = user_id);
    END IF;
END $$;

-- 4. User Plans Table
-- Stores the workout split
CREATE TABLE IF NOT EXISTS user_plans (
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  workout_plan JSONB,
  diet_plan JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable Security for Plans
ALTER TABLE user_plans ENABLE ROW LEVEL SECURITY;

DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_plans' AND policyname = 'Users can manage their own user_plans') THEN
        CREATE POLICY "Users can manage their own user_plans" ON user_plans FOR ALL USING (auth.uid() = user_id);
    END IF;
END $$;

-- 5. Storage Buckets (Optional - Un-comment if needed)
-- INSERT INTO storage.buckets (id, name, public) 
-- VALUES ('progress_photos', 'progress_photos', true)
-- ON CONFLICT (id) DO NOTHING;

-- CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING ( bucket_id = 'progress_photos' );
-- CREATE POLICY "Auth Upload" ON storage.objects FOR INSERT WITH CHECK ( bucket_id = 'progress_photos' AND auth.uid() = owner );
